trigger: none

pool:
  name: 'local-pool'

variables:
  - group: New variable group 03-Aug
  - name: imageName
    value: 'labazizlab/pyflash'

stages:
- stage: BuildAndPush
  displayName: 'Build and Push Docker Image'
  jobs:
    - job: BuildImage
      displayName: 'Build Docker Image'
      steps:
        - checkout: self

        - task: Docker@2
          displayName: 'Build Docker Image'
          inputs:
            containerRegistry: 'dockerhub-connection'
            repository: $(imageName)
            command: buildAndPush
            dockerfile: pro/Dockerfile
            buildContext: pro
            tags: build-$(Build.BuildId)

        - script: echo "##vso[task.setvariable variable=buildTag;isOutput=true]build-$(Build.BuildId)"
          name: SetTag  
          displayName: 'Set build tag as output'
- stage: UpdateYAML
  displayName: 'Update K8s YAML and Push'
  dependsOn: BuildAndPush
  jobs:
  - job: UpdateYAML
    displayName: 'Update and Push YAML'
    variables:
      tag: $[ dependencies.BuildAndPush.outputs['BuildImage.SetTag.buildTag'] ]
    steps:
    - checkout: self
      fetchDepth: 0

    - script: |
        echo "Updating Kubernetes deployment YAML"
        sed -i "s#\(labazizlab/pyflash:\).*#\1${tag}#g" ./k3s/deploy-py.yaml
      displayName: 'Update deployment YAML'

    - script: |
        git config --global user.email "202021016@fbsu.edu.sa"
        git config --global user.name "labazizlab"
        git add ./k3s/deploy-py.yaml
        git commit -m "update deploy tag to $tag"
        git pull origin main
        git push origin main
      displayName: 'Push updated YAML to GitHub

trigger: none

pool:
  name: 'local-pool'

variables:
  - group: New variable group 03-Aug
  - name: imageName
    value: 'labazizlab/pyflash'

stages:
- stage: BuildAndPush
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: BuildImage
    displayName: 'Build Docker Image'

    steps:
    - checkout: self

    - task: Docker@2
      displayName: 'Build Docker Image'
      inputs:
        containerRegistry: 'dockerhub-connection'
        repository: $(imageName)
        command: buildAndPush
        dockerfile: pro/Dockerfile
        buildContext: pro
        tags: build-$(Build.BuildId)

    - script: echo "##vso[task.setvariable variable=buildTag;isOutput=true]build-$(Build.BuildId)"
      name: SetTag
      displayName: 'Set build tag as output'

- stage: UpdateYAML
  displayName: 'Update K8s YAML and Push'
  dependsOn: BuildAndPush
  jobs:
  - job: UpdateYAML
    displayName: 'Update and Push YAML'
    variables:
      tag: $[ dependencies.BuildAndPush.outputs['BuildImage.SetTag.buildTag'] ]
    steps:
    - checkout: self
      fetchDepth: 0
      persistCredentials: true

    - script: |
        echo "Updating K3s deployment YAML"
        echo "Using tag: ${tag}"
        sed -i -E "s#(labazizlab/pyflash)(:[a-zA-Z0-9._-]*)?#\1:${tag}#g" k3s/deploy-py.yaml
      displayName: 'Update Deployment YAML'

    - script: |
        BRANCH_NAME=$(echo $(Build.SourceBranch) | sed 's#refs/heads/##')
        echo "Checking out branch: $BRANCH_NAME"
        git checkout $BRANCH_NAME
        git config user.name "labazizlab"
        git config user.email "202021016@fbsu.edu.sa"
        git add k3s/deploy-py.yaml
        git commit -m "Update deploy-py.yaml with image tag ${tag}" || echo "No changes to commit"
        git push origin $BRANCH_NAME
      displayName: 'Commit and Push Updated YAML'


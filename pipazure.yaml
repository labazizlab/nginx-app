trigger: none

pool:
  name: local-pool

variables:
- group: New variable group 31-Jul

- name: IMAGE_NAME 
  value: labazizlab/pyflash

- name: DEPLOYMENT_FILE 
  value: ./k3s/deploy-py.yaml

steps:

- checkout: self

- task: Bash@3
  displayName: 'Get Build ID'
  name: getBuild
  inputs:
    targetType: 'inline'
    script: |
      build_id=$(date +%s)
      echo "##vso[task.setvariable variable=BUILD_ID]$build_id"
      echo "Build ID: $build_id"

- task: Bash@3
  displayName: 'Build Docker Image'
  inputs:
    targetType: 'inline'
    script: |
      docker build -t $(IMAGE_NAME):$(BUILD_ID) -f ./pro/Dockerfile ./pro
      echo "Image built: $(IMAGE_NAME):$(BUILD_ID)"

- task: Bash@3
  displayName: 'Push Docker Image'
  inputs:
    targetType: 'inline'
    script: |
      echo $(DOCKER_PASSWORD) | docker login -u $(DOCKER_USERNAME) --password-stdin
      docker push $(IMAGE_NAME):$(BUILD_ID)

- task: Bash@3
  displayName: 'Update deployment.yaml with new tag'
  env: 
    GITHUB_USERNAME: $(GITHUB_USERNAME)
    GITHUB_TOKEN: $(GITHUB_TOKEN)
  inputs:
    targetType: 'inline'
    script: |
      set -e
      sed -i "s|image:.*$|image: $(IMAGE_NAME):$(BUILD_ID)|" $(DEPLOYMENT_FILE)
      echo "Updated deployment file with image: $(IMAGE_NAME):$(BUILD_ID)"

      git config --global user.email "202021016@fbsu.edu.sa"
      git config --global user.name "labazizlab"
      git remote set-url origin https://$(GITHUB_USERNAME):$(GITHUB_TOKEN)@github.com/labazizlab/nginx-app.git
      git checkout main
      git pull origin main
      git add $(DEPLOYMENT_FILE)
      git commit -m "Update image to $(BUILD_ID)"
      git push origin main
